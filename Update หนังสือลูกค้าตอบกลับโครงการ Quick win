var ss = SpreadsheetApp.openById("XXXXXXXXXXXXX"); //ใส่ SpreadsheetID ที่ใช้งาน
var sheet = ss.getSheetByName("XXXXXXXXXXXXX"); //ใช้ชื่อ Sheet ที่เราใช้ Send to Line Notify ที่เราตั้งไว้อ่านข้อมูล

// กำหนดค่า วัน/เดือน/ปี
  var date = Utilities.formatDate(new Date(), 'GMT+7', 'dd/MM/');
  var thaiyear = Number(Utilities.formatDate(new Date(), "GMT+7", "yyyy"))+543;
  var today = 'วันที่ '+date+thaiyear;

// ตั้งเวลาแจ้งเตือน
function TimeNotify() {
  
  //กำหนดวันที่ปัจจุบัน
  var  d = new Date(); //Today
  var daycur = d.getDay(); // Sunday - Saturday : 0 - 6
  var datecur = d.getDate(); // Date 1-31
  var HHmm = Utilities.formatDate(new Date(), "Asia/Bangkok", "HH:mm");
  
  // Set send notify every Friday at 15:30.
  var set_day = 5; // Sunday - Saturday : 0 - 6
  var set_HHmm = "15:30";

  //Logger.log(10%2);
  
  if(datecur%2 != 0){
    if(set_day == daycur){
      if(HHmm == set_HHmm){
        sendLineNotify();
      }
    }
  }
  
  // Set send notify every Wendesday at 09:00.
  var set_day2 = 3; // Sunday - Saturday : 0 - 6
  var set_HHmm2 = "09:00";
  
  if(set_day2 == daycur){
     if(HHmm == set_HHmm2){
        UpdateDocCustomerPermit();
     }
  }
}


function onOpen() {
  var ui = SpreadsheetApp.getUi();
  // Or DocumentApp or FormApp.
  ui.createMenu('Custom Menu')
      .addItem('Send Update Progress', 'menuItem1')
      .addItem('Send Update DocCustomerPermit', 'menuItem2')
      .addToUi();
}

function menuItem1() {
  SpreadsheetApp.getUi() // Or DocumentApp or FormApp.
     .alert('The update progress has been sent successfully.!');
  sendLineNotify();
}

function menuItem2() {
  SpreadsheetApp.getUi() // Or DocumentApp or FormApp.
     .alert('The update progress has been sent successfully.!');
  UpdateDocCustomerPermit();
}

function sendLineNotify() {

   //======= กำหนดข้อมูลวันที่ปัจจุบัน ===========//
     var d = new Date();                   //กำหนด d เก็บวันที่วันนี้
     var d_today = d.getDate();            // วันที่
     var m_today = d.getMonth()+1;         //เลขเดือน 0-11 เพื่อไปหา มกราคม-ธันวาคม
     var y_today = d.getFullYear()+543;    //เพิ่มปี ค.ศ. ให้เป็น พ.ศ.
     var hh_today = d.getHours();          //ชั่วโมง
     var mm_today = d.getMinutes();        //นาที
     var ss_today = d.getSeconds();        //วินาที
     var day_timestamp = d_today + "/" + m_today + "/" + y_today + ", " + hh_today + ":" + mm_today + ":" + ss_today;
     var day_today = d_today + "/" + m_today + "/" + y_today;

  var userDay = "🗓วันที่ "+day_today;
  //var values = sheet.getRange(4, 2, sheet.getLastRow(),sheet.getLastColumn()).getValues();
  var Data1 = sheet.getRange(4,2).getValue(); // ข้อมูลสายสีเขียว
  //var Data2 = sheet.getRange(4,4).getValue(); // ข้อมูลสายสีเขียว
  //var Data3 = sheet.getRange(4,5).getValue(); // ข้อมูลสายสีเขียว
  var Data4 = sheet.getRange(4,6).getValue(); // ข้อมูลสายสีเขียว
  var Data5 = sheet.getRange(4,7).getValue(); // ข้อมูลสายสีเขียว
  
  var Data1A = sheet.getRange(6,2).getValue(); // ข้อมูลสายสีม่วง 1
  //var Data2A = sheet.getRange(6,4).getValue(); // ข้อมูลสายสีม่วง 1
  //var Data3A = sheet.getRange(6,5).getValue(); // ข้อมูลสายสีม่วง 1
  var Data4A = sheet.getRange(6,6).getValue(); // ข้อมูลสายสีม่วง 1
  var Data5A = sheet.getRange(6,7).getValue(); // ข้อมูลสายสีม่วง 1
  
  var Data1B = sheet.getRange(10,2).getValue(); // ข้อมูลสายสีม่วง 2
  //var Data2B = sheet.getRange(10,4).getValue(); // ข้อมูลสายสีม่วง 2
  //var Data3B = sheet.getRange(10,5).getValue(); // ข้อมูลสายสีม่วง 2
  var Data4B = sheet.getRange(10,6).getValue(); // ข้อมูลสายสีม่วง 2
  var Data5B = sheet.getRange(10,7).getValue(); // ข้อมูลสายสีม่วง 2
  
  var DataS1 = sheet.getRange(12,2).getValue(); // จำนวนลูกค้ารวมทั้งโครงการ
  var DataS2 = sheet.getRange(12,6).getValue(); // จำนวนลูกค้ารวมทั้งหมดที่ตอบรับอนุมัติแบบก่อสร้าง
  var DataS3 = sheet.getRange(12,7).getValue(); // %รวมทั้งโครงการ
  
  var Line1 = "📣 สรุป Update 📣\nหนังสือขออนุญาตก่อสร้างของลูกค้า โครงการ Quick win\n" + userDay + "\n\n";
  var Line2 = "🟢🚈สายสีเขียว :\n";
  var Line3 = " - มีจำนวนลูกค้าทั้งหมด " + Data1 + " ราย\n";
  //var Line4 = " - ยังไม่รับหนังสือจาก กฟน. " + Data2 + " ราย\n";
  //var Line5 = " - ส่งหนังสือฯให้ลูกค้าแล้ว " + Data3 + " ราย\n";
  var Line6 = " - ลูกค้าที่ตอบหนังสือฯแล้ว " + Data4 + " ราย\n";
  var Line6A = "   (คิดเป็น " + Data5 + "%)\n\n";
  
  var Line7 = "🟣🚈สายสีม่วง 1 :\n";
  var Line8 = " - มีจำนวนลูกค้าทั้งหมด " + Data1A + " ราย\n";
  //var Line9 = " - ยังไม่รับหนังสือจาก กฟน. " + Data2A + " ราย\n";
  //var Line10 = " - ส่งหนังสือฯให้ลูกค้าแล้ว " + Data3A + " ราย\n";
  var Line11 = " - ลูกค้าที่ตอบหนังสือฯแล้ว " + Data4A + " ราย\n";
  var Line11A = "   (คิดเป็น " + Data5A + "%)\n\n";
  
  var Line12 = "🟣🚈สายสีม่วง 2 :\n";
  var Line13 = " - มีจำนวนลูกค้าทั้งหมด " + Data1B + " ราย\n";
  //var Line14 = " - ยังไม่รับหนังสือจาก กฟน. " + Data2B + " ราย\n";
  //var Line15 = " - ส่งหนังสือฯให้ลูกค้าแล้ว " + Data3B + " ราย\n";
  var Line16 = " - ลูกค้าที่ตอบหนังสือฯแล้ว " + Data4B + " ราย\n";
  var Line16A = "   (คิดเป็น " + Data5B + "%)\n\n";
  
  var Line17 = "🏢 ลูกค้าทั้งหมด " + DataS1 + " ราย\n";
  var Line18 = "📄 รวมตอบอนุมัติหนังสือฯ " + DataS2 + " ราย\n";
  var Line19 = "📈 คิดเป็น " + DataS3 + "% ของทั้งโครงการ😆\n\n";
  var Line20 = "📌📌📌📌📌📌📌📌📌";
  
  var title = Line1;
  //var green = Line2 + Line3 + Line4 + Line5 + Line6 + Line6A;
  var green = Line2 + Line3 + Line6 + Line6A;
  //var purple1 = Line7 + Line8 + Line9 + Line10 + Line11 + Line11A;
  var purple1 = Line7 + Line8 + Line11 + Line11A;
  //var purple2 = Line12 + Line13 + Line14 + Line15 + Line16 + Line16A;
  var purple2 = Line12 + Line13 + Line16 + Line16A;
  var bottom = Line17 + Line18 + Line19 + Line20;

  var messages = {
        "message": title + green + purple1 + purple2 + bottom,
        "stickerPackageId": "1",
        "stickerId": "2"
      };
  
  var token = ["XXXXXXXXXXXXX"];
               
  for(var i = 0; i<token.length; i++){
    var options = {
      "method": "post",
      "payload": messages,
      "headers": {
        "Authorization": "Bearer " + token[i]
       }
    };
  
    UrlFetchApp.fetch("https://notify-api.line.me/api/notify", options);
  }
}

function UpdateDocCustomerPermit() {

   //======= กำหนดข้อมูลวันที่ปัจจุบัน ===========//
     var d = new Date();                   //กำหนด d เก็บวันที่วันนี้
     var d_today = d.getDate();            // วันที่
     var m_today = d.getMonth()+1;         //เลขเดือน 0-11 เพื่อไปหา มกราคม-ธันวาคม
     var y_today = d.getFullYear()+543;    //เพิ่มปี ค.ศ. ให้เป็น พ.ศ.
     var hh_today = d.getHours();          //ชั่วโมง
     var mm_today = d.getMinutes();        //นาที
     var ss_today = d.getSeconds();        //วินาที
     var day_timestamp = d_today + "/" + m_today + "/" + y_today + ", " + hh_today + ":" + mm_today + ":" + ss_today;
     var day_today = d_today + "/" + m_today + "/" + y_today;

  var userDay = "🗓วันที่ "+day_today;
  
  var Line1 = "\nเรียน ทีมงานที่ปรึกษา\n\n";
  var Line2 = "      รบกวน Update สถานะของการตอบกลับหนังสือขออนุญาตก่อสร้างในพื้นที่ของลูกค้าของแต่ละเส้นทาง ตาม Link ด้านล่างนี้ครับ👇🏻\n\n";
  var Line3 = "https://docs.google.com/spreadsheets/d/XXXXXXXXXXXXX";
  
  var Line4 = "\n      และช่วย Upload File หนังสือตอบกลับจากลูกค้าไว้ใน Google drive ตาม Link ด้านล่างนี้ด้วยครับ👇🏻\n\n";
  var Line5 = "https://drive.google.com/drive/folders/XXXXXXXXXXXXX";
  var Line6 = "\n\n"+"ขอบคุณครับ";
  
  var title = Line1;
  var body1 = Line2 + Line3;
  var body2 = Line4 + Line5 + Line6;
  
  var messages1 = {
        "message": title + body1
      };
  var messages2 = {
        "message": body2
      };
      
  var token = ["XXXXXXXXXXXXX"];
               
  for(var i = 0; i<token.length; i++){
    var options = {
      "method": "post",
      "payload": messages1,
      "headers": {
        "Authorization": "Bearer " + token[i]
       }
    };
  
    UrlFetchApp.fetch("https://notify-api.line.me/api/notify", options);
  }
  
  for(var i = 0; i<token.length; i++){
    var options = {
      "method": "post",
      "payload": messages2,
      "headers": {
        "Authorization": "Bearer " + token[i]
       }
    };
  
    UrlFetchApp.fetch("https://notify-api.line.me/api/notify", options);
  }
}
